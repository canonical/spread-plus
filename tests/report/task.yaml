summary: Test the json report

prepare: |
    if [ ! -f .spread-reuse.yaml ]; then
        touch /run/spread-reuse.yaml
        ln -s /run/spread-reuse.yaml .spread-reuse.yaml
    fi

restore: |
    rm -f exec1.out exec2.out exec3.out

execute: |
    # Check the suite where all the tests pass
    spread -reuse -resend -json test.json lxd:ubuntu-22.04:checks/suite-2/
    test 2 -eq $(jq -r '.results."task-passed"' < test.json)
    test 0 -eq $(jq -r '.results."task-failed"' < test.json)
    test 0 -eq $(jq -r '.results."task-aborted"' < test.json)
    # No suite prepare and restore tasks
    test 0 -eq $(jq -r '[.items[] | select( .level == "suite" )] | length' test.json)

    # Check the suite with different errors

    # prepare fails
    spread -reuse -resend -json test.json lxd:ubuntu-22.04:checks/suite-1/task-1-2 || true
    test 0 -eq $(jq -r '.results."task-passed"' < test.json)
    test 0 -eq $(jq -r '.results."task-failed"' < test.json)
    test 1 -eq $(jq -r '.results."task-aborted"' < test.json)
    test 1 -eq $(jq -r '.results."task-prepare-failed"' < test.json)
    test 0 -eq $(jq -r '.results."task-restore-failed"' < test.json)
    test 1 -eq $(jq -r '[.items[] | select( .aborted == true )] | length' test.json)

    # restore fails
    spread -reuse -resend -json test.json lxd:ubuntu-22.04:checks/suite-1/task-1-3 || true
    test 1 -eq $(jq -r '.results."task-passed"' < test.json)
    test 0 -eq $(jq -r '.results."task-failed"' < test.json)
    test 0 -eq $(jq -r '.results."task-aborted"' < test.json)
    test 0 -eq $(jq -r '.results."task-prepare-failed"' < test.json)
    test 1 -eq $(jq -r '.results."task-restore-failed"' < test.json)

    # execution fails
    spread -reuse -resend -json test.json lxd:ubuntu-22.04:checks/suite-1/task-1-4 || true
    test 0 -eq $(jq -r '.results."task-passed"' < test.json)
    test 1 -eq $(jq -r '.results."task-failed"' < test.json)
    test 0 -eq $(jq -r '.results."task-aborted"' < test.json)
    test 0 -eq $(jq -r '.results."task-prepare-failed"' < test.json)
    test 0 -eq $(jq -r '.results."task-restore-failed"' < test.json)

    # execution fails and debug fails
    spread -reuse -resend -json test.json lxd:ubuntu-22.04:checks/suite-1/task-1-5 || true
    test 0 -eq $(jq -r '.results."task-passed"' < test.json)
    test 1 -eq $(jq -r '.results."task-failed"' < test.json)
    test 0 -eq $(jq -r '.results."task-aborted"' < test.json)
    test 0 -eq $(jq -r '.results."task-prepare-failed"' < test.json)
    test 0 -eq $(jq -r '.results."task-restore-failed"' < test.json)
    test 1 -eq $(jq -r '[.items[] | select( .verb == "executing" and .success==false )] | length' test.json)
    # Debugging verbs are not recorded in reports
    test 0 -eq $(jq -r '[.items[] | select( .verb == "debugging" and .success==false )] | length' test.json)

    # execution fails and restore fails
    spread -reuse -resend -json test.json lxd:ubuntu-22.04:checks/suite-1/task-1-6 || true
    test 0 -eq $(jq -r '.results."task-passed"' < test.json)
    test 1 -eq $(jq -r '.results."task-failed"' < test.json)
    test 0 -eq $(jq -r '.results."task-aborted"' < test.json)
    test 0 -eq $(jq -r '.results."task-prepare-failed"' < test.json)
    test 1 -eq $(jq -r '.results."task-restore-failed"' < test.json)
    test 1 -eq $(jq -r '[.items[] | select( .verb == "preparing" and .level == "task" and .success==true )] | length' test.json)
    test 0 -eq $(jq -r '[.items[] | select( .verb == "preparing" and .level == "suite" and .success==true )] | length' test.json)
    test 1 -eq $(jq -r '[.items[] | select( .verb == "preparing" and .level == "project" and .success==true )] | length' test.json)
    test 1 -eq $(jq -r '[.items[] | select( .verb == "executing" and .success==false )] | length' test.json)
    test 1 -eq $(jq -r '[.items[] | select( .verb == "restoring" and .level == "task" and .success==false )] | length' test.json)
    test 0 -eq $(jq -r '[.items[] | select( .verb == "restoring" and .level == "suite" )] | length' test.json)
    test 1 -eq $(jq -r '[.items[] | select( .verb == "restoring" and .level == "project" and .success==true )] | length' test.json)

    # execution is skipped
    spread -reuse -resend -json test.json lxd:ubuntu-22.04:checks/suite-1/task-1-7
    test 0 -eq $(jq -r '.results."task-passed"' < test.json)
    test 0 -eq $(jq -r '.results."task-failed"' < test.json)
    test 0 -eq $(jq -r '.results."task-aborted"' < test.json)
    test 1 -eq $(jq -r '.results."task-skipped"' < test.json)
    test 1 -eq $(jq -r '[.items[] | select( .skipped == true )] | length' test.json)

    # Check the suite which fails to prepare
    spread -reuse -resend -json test.json lxd:ubuntu-22.04:checks/suite-3/ || true
    test 0 -eq $(jq -r '.results."task-passed"' < test.json)
    test 0 -eq $(jq -r '.results."task-failed"' < test.json)
    test 2 -eq $(jq -r '.results."task-aborted"' < test.json)
    test 0 -eq $(jq -r '.results."task-prepare-failed"' < test.json)
    test 0 -eq $(jq -r '.results."task-restore-failed"' < test.json)
    test 1 -eq $(jq -r '.results."suite-prepare-failed"' < test.json)
    test 0 -eq $(jq -r '.results."suite-restore-failed"' < test.json)
    test 2 -eq $(jq -r '[.items[] | select( .aborted == true )] | length' test.json)
    test 0 -eq $(jq -r '[.items[] | select( .skipped == true )] | length' test.json)

    # Check the suite which fails to restore
    spread -reuse -resend -json test.json lxd:ubuntu-22.04:checks/suite-4/ || true
    test 2 -eq $(jq -r '.results."task-passed"' < test.json)
    test 0 -eq $(jq -r '.results."task-failed"' < test.json)
    test 0 -eq $(jq -r '.results."task-aborted"' < test.json)
    test 0 -eq $(jq -r '.results."task-prepare-failed"' < test.json)
    test 0 -eq $(jq -r '.results."task-restore-failed"' < test.json)
    test 0 -eq $(jq -r '.results."suite-prepare-failed"' < test.json)
    test 1 -eq $(jq -r '.results."suite-restore-failed"' < test.json)
    test 0 -eq $(jq -r '[.items[] | select( .aborted == true )] | length' test.json)

    # Check the test with variant
    spread -reuse -resend -json test.json lxd:ubuntu-22.04:checks/suite-5/ || true
    test 2 -eq $(jq -r '.results."task-passed"' < test.json)
    test 0 -eq $(jq -r '.results."task-failed"' < test.json)
    test 0 -eq $(jq -r '.results."task-aborted"' < test.json)
    test 0 -eq $(jq -r '.results."task-prepare-failed"' < test.json)
    test 0 -eq $(jq -r '.results."task-restore-failed"' < test.json)
    test 0 -eq $(jq -r '.results."suite-prepare-failed"' < test.json)
    test 0 -eq $(jq -r '.results."suite-restore-failed"' < test.json)
    test 0 -eq $(jq -r '[.items[] | select( .aborted == true )] | length' test.json)
    # Prepare and restore project
    test 2 -eq $(jq -r '[.items[] | select( .level == "project" )] | length' test.json)
    test 2 -eq $(jq -r '[.items[] | select( .level == "project" and .variant == "" )] | length' test.json)
    # Prepare and restore suite
    test 2 -eq $(jq -r '[.items[] | select( .level == "suite" and .name == "checks/suite-5/" )] | length' test.json)
    test 2 -eq $(jq -r '[.items[] | select( .level == "suite" and .variant == "" )] | length' test.json)
    # Execute tests
    test 1 -eq $(jq -r '[.items[] | select( .level == "task" and .verb == "executing" and .variant == "one" )] | length' test.json)
    test 1 -eq $(jq -r '[.items[] | select( .level == "task" and .verb == "executing" and.variant == "two" )] | length' test.json)

    # Check the suite is skipped
    spread -reuse -resend -json test.json lxd:ubuntu-22.04:checks/suite-6/
    test 0 -eq $(jq -r '.results."task-passed"' < test.json)
    test 0 -eq $(jq -r '.results."task-failed"' < test.json)
    test 0 -eq $(jq -r '.results."task-aborted"' < test.json)
    test 0 -eq $(jq -r '.results."task-skipped"' < test.json)
    test 1 -eq $(jq -r '.results."suite-skipped"' < test.json)
    # No suite prepare and restore tasks
    test 0 -eq $(jq -r '[.items[] | select( .level == "suite" and .verb == "preparing" )] | length' test.json)
    test 0 -eq $(jq -r '[.items[] | select( .level == "suite" and .verb == "restoring" )] | length' test.json)
    test 1 -eq $(jq -r '[.items[] | select( .level == "suite" and .verb == "checking" )] | length' test.json)
    # two tests and 1 suite with skipped status
    test 0 -eq $(jq -r '[.items[] | select( .level == "task" and .skipped == true )] | length' test.json)
    test 1 -eq $(jq -r '[.items[] | select( .level == "suite" and .skipped == true )] | length' test.json)