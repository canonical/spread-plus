# This spread setup is used to test spread with spread itself. For that, the
# spread interpreting this file is assumed to be working based on prior
# testing, while the spread code being shipped to the remote server is being
# verified for correctness. See the tests to have an idea of how that's done.
# Keep in mind that the logic in task.yaml is supposed to test the *built*
# spread, not the one running the task.yaml logic.

project: spread

environment:
    GOCHANNEL: 1.24/stable
    GOHOME: /home/test
    GOPATH: $GOHOME
    PATH: $GOHOME/bin:$PATH
    CACHE_DISABLED: $(HOST:[ "$SEND_CACHE" = 1 ] && echo false || echo tests/cache)

backends:
    google:
        key: "$(HOST: echo $SPREAD_GOOGLE_KEY)"
        location: snapd-spread/us-east1-b
        halt-timeout: 2h
        systems:
            - ubuntu-22.04-64:
                image: ubuntu-2204-64-virt-enabled
                workers: 1
    openstack:
        key: '$(HOST: echo "$OS_CREDENTIALS_AMD64_PS7")'
        plan: shared.small
        halt-timeout: 2h
        wait-timeout: 10m
        groups: [default]
        proxy: ingress-haproxy.ps7.canonical.com
        cidr-port-rel: [10.151.96.0/21:5000]
        volume-auto-delete: true
        environment:
            HTTP_PROXY: 'http://egress.ps7.internal:3128'
            HTTPS_PROXY: 'http://egress.ps7.internal:3128'
            http_proxy: 'http://egress.ps7.internal:3128'
            https_proxy: 'http://egress.ps7.internal:3128'
            no_proxy: '127.0.0.1,127.0.0.53,localhost'
            NO_PROXY: '127.0.0.1,127.0.0.53,localhost'
            NTP_SERVER: 'ntp.ps7.internal'
        systems:
            - ubuntu-22.04-64:
                image: snapd-spread/ubuntu-22.04-64

exclude:
    - .spread-reuse.yaml
    - tests/.spread-reuse.yaml
    - $CACHE_DISABLED

path: /home/test/src/github.com/snapcore/spread

kill-timeout: 10m
warn-timeout: 2m

suites:
    tests/: 
        summary: Integration tests

prepare: |
    DEBS="jq git qemu-kvm tree"
    if ! dpkg -l $DEBS; then
        apt update
        apt install -y $DEBS
    fi

    if [ -n "${http_proxy:-}" ]; then
        snap set system proxy.http="$http_proxy"
    fi
    if [ -n "${https_proxy:-}" ]; then
        snap set system proxy.https="$https_proxy"
    fi

    snap install lxd
    lxd waitready

    if [ -n "${http_proxy:-}" ]; then
        lxd.lxc config set core.proxy_http "$http_proxy"
        lxd.lxc profile set default environment.http_proxy "$http_proxy"
    fi
    if [ -n "${https_proxy:-}" ]; then
        lxd.lxc config set core.proxy_https "$https_proxy"
        lxd.lxc profile set default environment.https_proxy "$https_proxy"
    fi
    lxd init --auto

    # Either use pregenerated spread if exists or build it
    mkdir -p "$GOHOME/bin"
    if [ -x ./bin/spread ]; then
        mv -f ./bin/spread "$GOHOME/bin/spread"
    else
        # Cache Go deb with: cd tests/cache && godeb download $GOVERSION
        if ! snap list go; then
            snap install go --classic --channel "$GOCHANNEL"
        fi
        /snap/bin/go build -o spread-plus cmd/spread/main.go
        mv -f ./spread-plus "$GOHOME/bin/spread"
    fi

# vim:ts=4:sw=4:et
